<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ON/OFF Logger - Updated Firestore (Refactored)</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
     /* === Restore body background design from the first version === */
body {
  background: linear-gradient(145deg, #f0f0f0, #dcdcdc);
  font-family: 'Arial', sans-serif;
  text-align: center;
  margin-top: 50px;
  padding: 0;
  margin: 0;
  color: #333;
}
    button {
      font-size: 18px;
      padding: 14px 36px;
      margin: 15px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      position: relative;
      background: #ffffff;
      transition: transform 0.3s ease, background 0.5s ease, color 0.4s ease;
      color: #333;
      user-select: none;
    }
    .on { background: linear-gradient(145deg, #4caf50, #45a049); color: white; }
    .off { background: linear-gradient(145deg, #f44336, #e53935); color: white; }
    button:hover { transform: scale(1.08); transition: transform 0.3s ease; }
    button:focus { outline: none; }
    button:active { transform: scale(0.95); }
    .on:active { background: linear-gradient(145deg, #45a049, #4caf50); }
    .off:active { background: linear-gradient(145deg, #e53935, #f44336); }
    @keyframes pulse { 0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)} }
    .on:active, .off:active { animation: pulse 0.8s ease-out; }
    button:disabled { background: #ddd; color: #aaa; cursor: not-allowed; }

    .download { background: linear-gradient(145deg, #2196f3, #1976d2); color: white; }
    #loading { display: none; font-size: 18px; color: green; }


   #timerCollege, #timerShadharonBima, #timerRDA, #timerShahebBazar, #timerKumarpara, #timerBiddutVobon, 
   #timerKolabagan, #timerMedical, #timerPoromanu, #timerBTV, #timerCircuitHouse, #timerNovoTheater, #timerKatakhali, 
   #timerMiapur, #timerBindurMor, #timerTalaimari
   {
      font-size: 36px; margin: 20px; font-weight: bold; color: #333;
    }

    #buttonAreaCollege, #buttonAreaShadharonBima, #buttonAreaRDA, #buttonAreaShahebBazar, #buttonAreaKumarpara, 
    #buttonAreaBiddutVobon, #buttonAreaKolabagan, #buttonAreaMedical, #buttonAreaPoromanu, #buttonAreaBTV, 
    #buttonAreaCircuitHouse, #buttonAreaNovoTheater, #buttonAreaKatakhali, #buttonAreaMiapur, #buttonAreaBindurMor, #buttonAreaTalaimari
 { margin-bottom: 30px; }

   #lastInterruptionCollege, #lastInterruptionShadharonBima, #lastInterruptionRDA, 
   #lastInterruptionShahebBazar, #lastInterruptionKumarpara, #lastInterruptionBiddutVobon, 
   #lastInterruptionKolabagan, #lastInterruptionMedical, #lastInterruptionPoromanu, #lastInterruptionBTV, 
   #lastInterruptionCircuitHouse, #lastInterruptionNovoTheater, #lastInterruptionKatakhali, #lastInterruptionMiapur, 
   #lastInterruptionBindurMor, #lastInterruptionTalaimari
 {
      margin-top: 20px; font-size: 22px; background: white; display: inline-block;
      padding: 15px 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      color: #555; font-weight: bold; transition: opacity 0.5s ease, transform 0.3s ease;
    }

    table {
      margin: 40px auto; border-collapse: collapse; background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-radius: 10px;
    }
    th, td { padding: 12px 25px; border: 1px solid #ccc; font-size: 16px; text-align: center; }
    th { background-color: #f1f1f1; color: #555; }
    tr:hover { background-color: #f9f9f9; transform: scale(1.02); }

   #statusButtonCollege, #statusButtonShadharonBima, #statusButtonRDA, #statusButtonShahebBazar, 
   #statusButtonKumarpara, #statusButtonBiddutVobon, #statusButtonKolabagan, #statusButtonMedical, 
   #statusButtonPoromanu, #statusButtonBTV, #statusButtonCircuitHouse, #statusButtonNovoTheater, #statusButtonKatakhali, 
   #statusButtonMiapur, #statusButtonBindurMor, #statusButtonTalaimari
 {
      font-size: 28px; padding: 18px 50px; border-radius: 50px; margin-bottom: 20px;
      transition: transform 0.4s cubic-bezier(0.68,-0.55,0.265,1.55), box-shadow 0.4s ease;
    }

    .card {
      background: #ffffff; border-radius: 20px; box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      padding: 30px 20px; margin: 20px auto; width: 90%; max-width: 600px; transition: all 0.3s ease;
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 10px 24px rgba(0,0,0,0.15); }
    .card h2 { font-size: 26px; margin-bottom: 20px; color: #444; }


    .info-card {
      --accent: #6c63ff;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 18px;
      padding: 28px 32px;
      border-radius: 20px;
      border-left: 8px solid var(--accent);
      background: linear-gradient(135deg, #75c3ff, #f8f8fb);
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      width: 90%;
      max-width: 550px;
      margin: 20px auto;
      text-align: center;
    }
    .info-card .icon {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 35px;
      color: var(--accent);
      background: #f2f3ff;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,0.05);
    }
    .info-card h2 {
      margin: 0;
      font-size: 32px;
      font-weight: bold;
      color: #333;
    }

    .info-card.source { --accent: #8e2de2; }
    .info-card.feeder { --accent: #2196f3; }

    button.on, button.off {
  display: none;
}


  </style>
</head>
<body>

</div>


  <!-- Top "Source" Card -->
  <div class="info-card source">
    <span class="icon">âš¡</span>
    <h2>Source</h2>
  </div>

  <div class="card">
    <!-- Katakhali -->
    <button id="statusButtonKatakhali">Katakhali</button>
    <div id="timerKatakhali">00:00:00:00</div>
    <div id="buttonAreaKatakhali">
      <button id="onButtonKatakhali" class="on">ON</button>
      <button id="offButtonKatakhali" class="off">OFF</button>
      <div id="lastInterruptionKatakhali">Last Interruption: --</div>
    </div>
  <hr style="margin:20px 0; opacity:.2;">

    <!-- Miapur -->
    <button id="statusButtonMiapur">Miapur</button>
    <div id="timerMiapur">00:00:00:00</div>
    <div id="buttonAreaMiapur">
      <button id="onButtonMiapur" class="on">ON</button>
      <button id="offButtonMiapur" class="off">OFF</button>
      <div id="lastInterruptionMiapur">Last Interruption: --</div>
    </div>
  <hr style="margin:20px 0; opacity:.2;">

    <!-- Bindur Mor -->
    <button id="statusButtonBindurMor">Bindur Mor</button>
    <div id="timerBindurMor">00:00:00:00</div>
    <div id="buttonAreaBindurMor">
      <button id="onButtonBindurMor" class="on">ON</button>
      <button id="offButtonBindurMor" class="off">OFF</button>
      <div id="lastInterruptionBindurMor">Last Interruption: --</div>
    </div>
  <hr style="margin:20px 0; opacity:.2;">

    <!-- Talaimari -->
    <button id="statusButtonTalaimari">Talaimari</button>
    <div id="timerTalaimari">00:00:00:00</div>
    <div id="buttonAreaTalaimari">
      <button id="onButtonTalaimari" class="on">ON</button>
      <button id="offButtonTalaimari" class="off">OFF</button>
      <div id="lastInterruptionTalaimari">Last Interruption: --</div>
    </div>
  <hr style="margin:20px 0; opacity:.2;">
  
  </div>

<!-- "Feeder" Card (before Sultanabad) -->
<div class="info-card feeder">
  <span class="icon">ðŸ”Œ</span>
  <h2>Feeder</h2>
</div>

<!-- College Card -->
<div class="card">
  <button id="statusButtonCollege">College</button>
  <div id="timerCollege">00:00:00</div>
  <div id="buttonAreaCollege">
    <button id="onButtonCollege" class="on">ON</button>
    <button id="offButtonCollege" class="off">OFF</button>
    <div id="lastInterruptionCollege">Last Interruption: --</div>
  </div>
</div>


<!-- Shadharon Bima Card -->
<div class="card">
  <button id="statusButtonShadharonBima">Shadharon Bima</button>
  <div id="timerShadharonBima">00:00:00</div>
  <div id="buttonAreaShadharonBima">
    <button id="onButtonShadharonBima" class="on">ON</button>
    <button id="offButtonShadharonBima" class="off">OFF</button>
    <div id="lastInterruptionShadharonBima">Last Interruption: --</div>
  </div>
</div>


<!-- RDA Card -->
<div class="card">
  <button id="statusButtonRDA">RDA</button>
  <div id="timerRDA">00:00:00</div>
  <div id="buttonAreaRDA">
    <button id="onButtonRDA" class="on">ON</button>
    <button id="offButtonRDA" class="off">OFF</button>
    <div id="lastInterruptionRDA">Last Interruption: --</div>
  </div>
</div>


<!-- Shaheb Bazar Card -->
<div class="card">
  <button id="statusButtonShahebBazar">Shaheb Bazar</button>
  <div id="timerShahebBazar">00:00:00</div>
  <div id="buttonAreaShahebBazar">
    <button id="onButtonShahebBazar" class="on">ON</button>
    <button id="offButtonShahebBazar" class="off">OFF</button>
    <div id="lastInterruptionShahebBazar">Last Interruption: --</div>
  </div>
</div>


<!-- Kumarpara Card -->
<div class="card">
  <button id="statusButtonKumarpara">Kumarpara</button>
  <div id="timerKumarpara">00:00:00</div>
  <div id="buttonAreaKumarpara">
    <button id="onButtonKumarpara" class="on">ON</button>
    <button id="offButtonKumarpara" class="off">OFF</button>
    <div id="lastInterruptionKumarpara">Last Interruption: --</div>
  </div>
</div>


<!-- Biddut Vobon Card -->
<div class="card">
  <button id="statusButtonBiddutVobon">Biddut Vobon</button>
  <div id="timerBiddutVobon">00:00:00</div>
  <div id="buttonAreaBiddutVobon">
    <button id="onButtonBiddutVobon" class="on">ON</button>
    <button id="offButtonBiddutVobon" class="off">OFF</button>
    <div id="lastInterruptionBiddutVobon">Last Interruption: --</div>
  </div>
</div>


<!-- Kolabagan Card -->
<div class="card">
  <button id="statusButtonKolabagan">Kolabagan</button>
  <div id="timerKolabagan">00:00:00</div>
  <div id="buttonAreaKolabagan">
    <button id="onButtonKolabagan" class="on">ON</button>
    <button id="offButtonKolabagan" class="off">OFF</button>
    <div id="lastInterruptionKolabagan">Last Interruption: --</div>
  </div>
</div>


<!-- Medical Card -->
<div class="card">
  <button id="statusButtonMedical">Medical</button>
  <div id="timerMedical">00:00:00</div>
  <div id="buttonAreaMedical">
    <button id="onButtonMedical" class="on">ON</button>
    <button id="offButtonMedical" class="off">OFF</button>
    <div id="lastInterruptionMedical">Last Interruption: --</div>
  </div>
</div>


<!-- Poromanu Card -->
<div class="card">
  <button id="statusButtonPoromanu">Poromanu</button>
  <div id="timerPoromanu">00:00:00</div>
  <div id="buttonAreaPoromanu">
    <button id="onButtonPoromanu" class="on">ON</button>
    <button id="offButtonPoromanu" class="off">OFF</button>
    <div id="lastInterruptionPoromanu">Last Interruption: --</div>
  </div>
</div>


<!-- BTV Card -->
<div class="card">
  <button id="statusButtonBTV">BTV</button>
  <div id="timerBTV">00:00:00</div>
  <div id="buttonAreaBTV">
    <button id="onButtonBTV" class="on">ON</button>
    <button id="offButtonBTV" class="off">OFF</button>
    <div id="lastInterruptionBTV">Last Interruption: --</div>
  </div>
</div>


<!-- Circuit House Card -->
<div class="card">
  <button id="statusButtonCircuitHouse">Circuit House</button>
  <div id="timerCircuitHouse">00:00:00</div>
  <div id="buttonAreaCircuitHouse">
    <button id="onButtonCircuitHouse" class="on">ON</button>
    <button id="offButtonCircuitHouse" class="off">OFF</button>
    <div id="lastInterruptionCircuitHouse">Last Interruption: --</div>
  </div>
</div>


<!-- Novo Theater Card -->
<div class="card">
  <button id="statusButtonNovoTheater">Novo Theater</button>
  <div id="timerNovoTheater">00:00:00</div>
  <div id="buttonAreaNovoTheater">
    <button id="onButtonNovoTheater" class="on">ON</button>
    <button id="offButtonNovoTheater" class="off">OFF</button>
    <div id="lastInterruptionNovoTheater">Last Interruption: --</div>
  </div>
</div>



<br>
<!-- Download and Share Buttons -->
<button id="downloadButton" class="download">Download Logs (Excel)</button>
<p id="loading">Downloading...</p>
<!-- New: Upload and Reset Buttons under Download -->
<button id="resetButton" class="reset">Reset</button>



<table id="logTable" border="1">
  <thead>
    <tr>
      <th>Date</th>
      <th>Action</th>
      <th>Time</th>
      <th>Location</th>
      <th>Interruption</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // Initialize Firebase
 const firebaseConfig = {
    apiKey: "AIzaSyAy53-F5QZ5a0f9DW9emesit1KA2T7v7Do",
    authDomain: "testt-b241d.firebaseapp.com",
    projectId: "testt-b241d",
    storageBucket: "testt-b241d.appspot.com",
    messagingSenderId: "288476078303",
    appId: "1:288476078303:android:ff06d4a9d5c432f41ac96a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- Stations configuration (keeps all IDs and behavior unchanged) ---
  const stations = [
    { name: 'College', statDoc: 'f11_stat', logsCol: 'f11_logs', lastDoc: 'f11_last', ids: {statusBtn:'statusButtonCollege', timer:'timerCollege', on:'onButtonCollege', off:'offButtonCollege', last:'lastInterruptionCollege'} },
    { name: 'Shadharon Bima', statDoc: 'f12_stat', logsCol: 'f12_logs', lastDoc: 'f12_last', ids: {statusBtn:'statusButtonShadharonBima', timer:'timerShadharonBima', on:'onButtonShadharonBima', off:'offButtonShadharonBima', last:'lastInterruptionShadharonBima'} },
    { name: 'RDA', statDoc: 'f13_stat', logsCol: 'f13_logs', lastDoc: 'f13_last', ids: {statusBtn:'statusButtonRDA', timer:'timerRDA', on:'onButtonRDA', off:'offButtonRDA', last:'lastInterruptionRDA'} },
    { name: 'Shaheb Bazar', statDoc: 'f14_stat', logsCol: 'f14_logs', lastDoc: 'f14_last', ids: {statusBtn:'statusButtonShahebBazar', timer:'timerShahebBazar', on:'onButtonShahebBazar', off:'offButtonShahebBazar', last:'lastInterruptionShahebBazar'} },
    { name: 'Kumarpara', statDoc: 'f15_stat', logsCol: 'f15_logs', lastDoc: 'f15_last', ids: {statusBtn:'statusButtonKumarpara', timer:'timerKumarpara', on:'onButtonKumarpara', off:'offButtonKumarpara', last:'lastInterruptionKumarpara'} },
    { name: 'Biddut Vobon', statDoc: 'f16_stat', logsCol: 'f16_logs', lastDoc: 'f16_last', ids: {statusBtn:'statusButtonBiddutVobon', timer:'timerBiddutVobon', on:'onButtonBiddutVobon', off:'offButtonBiddutVobon', last:'lastInterruptionBiddutVobon'} },
    { name: 'Kolabagan', statDoc: 'f17_stat', logsCol: 'f17_logs', lastDoc: 'f17_last', ids: {statusBtn:'statusButtonKolabagan', timer:'timerKolabagan', on:'onButtonKolabagan', off:'offButtonKolabagan', last:'lastInterruptionKolabagan'} },
    { name: 'Medical', statDoc: 'f18_stat', logsCol: 'f18_logs', lastDoc: 'f18_last', ids: {statusBtn:'statusButtonMedical', timer:'timerMedical', on:'onButtonMedical', off:'offButtonMedical', last:'lastInterruptionMedical'} },
    { name: 'Poromanu', statDoc: 'f19_stat', logsCol: 'f19_logs', lastDoc: 'f19_last', ids: {statusBtn:'statusButtonPoromanu', timer:'timerPoromanu', on:'onButtonPoromanu', off:'offButtonPoromanu', last:'lastInterruptionPoromanu'} },
    { name: 'BTV', statDoc: 'f20_stat', logsCol: 'f20_logs', lastDoc: 'f20_last', ids: {statusBtn:'statusButtonBTV', timer:'timerBTV', on:'onButtonBTV', off:'offButtonBTV', last:'lastInterruptionBTV'} },
    { name: 'Circuit House', statDoc: 'f21_stat', logsCol: 'f21_logs', lastDoc: 'f21_last', ids: {statusBtn:'statusButtonCircuitHouse', timer:'timerCircuitHouse', on:'onButtonCircuitHouse', off:'offButtonCircuitHouse', last:'lastInterruptionCircuitHouse'} },
    { name: 'Novo Theater', statDoc: 'f22_stat', logsCol: 'f22_logs', lastDoc: 'f22_last', ids: {statusBtn:'statusButtonNovoTheater', timer:'timerNovoTheater', on:'onButtonNovoTheater', off:'offButtonNovoTheater', last:'lastInterruptionNovoTheater'} },
    { name: 'Katakhali', statDoc: 'f23_stat', logsCol: 'f23_logs', lastDoc: 'f23_last', ids: {statusBtn:'statusButtonKatakhali', timer:'timerKatakhali', on:'onButtonKatakhali', off:'offButtonKatakhali', last:'lastInterruptionKatakhali'} },
    { name: 'Miapur', statDoc: 'f24_stat', logsCol: 'f24_logs', lastDoc: 'f24_last', ids: {statusBtn:'statusButtonMiapur', timer:'timerMiapur', on:'onButtonMiapur', off:'offButtonMiapur', last:'lastInterruptionMiapur'} },
    { name: 'Bindur Mor', statDoc: 'f25_stat', logsCol: 'f25_logs', lastDoc: 'f25_last', ids: {statusBtn:'statusButtonBindurMor', timer:'timerBindurMor', on:'onButtonBindurMor', off:'offButtonBindurMor', last:'lastInterruptionBindurMor'} },
    { name: 'Talaimari', statDoc: 'f26_stat', logsCol: 'f26_logs', lastDoc: 'f26_last', ids: {statusBtn:'statusButtonTalaimari', timer:'timerTalaimari', on:'onButtonTalaimari', off:'offButtonTalaimari', last:'lastInterruptionTalaimari'} },
];


  // Create maps for Firestore refs and DOM elements
  const statusDocs = {};
  const logsCols = {};
  const lastDocs = {};
  const elems = {};
  const timerIntervals = {};

  stations.forEach(s => {
    statusDocs[s.name] = db.collection('Substation2').doc(s.statDoc);
    logsCols[s.name] = db.collection(s.logsCol);
    lastDocs[s.name] = db.collection('Substation2').doc(s.lastDoc);

    elems[s.name] = {
      statusBtn: document.getElementById(s.ids.statusBtn),
      timer: document.getElementById(s.ids.timer),
      onBtn: document.getElementById(s.ids.on),
      offBtn: document.getElementById(s.ids.off),
      lastDiv: document.getElementById(s.ids.last)
    };

    timerIntervals[s.name] = { timer: null };
  });

  // Keep a reference to the table and controls used elsewhere
  const downloadBtn = document.getElementById('downloadButton');
  const loadingText = document.getElementById('loading');
  const logTable = document.getElementById('logTable').querySelector('tbody');

  // Preserve function names and behavior exactly
  function animateButton(button, state) {
    button.style.transition = "transform 0.4s cubic-bezier(0.68,-0.55,0.265,1.55), box-shadow 0.4s ease";
    button.style.transform = "scale(1.15)";
    button.style.boxShadow = state === "ON" ? "0 0 20px 5px rgba(0,255,0,0.6)" : "0 0 20px 5px rgba(255,0,0,0.6)";
    setTimeout(() => { button.style.transform = "scale(1)"; button.style.boxShadow = "none"; }, 400);
  }

  function startTimer(element, start, holder) {
    if (holder.timer) clearInterval(holder.timer);
    holder.timer = setInterval(() => {
      const now = new Date();
      const diff = Math.floor((now - start) / 1000);
      const h = String(Math.floor(diff / 3600)).padStart(2,'0');
      const m = String(Math.floor((diff % 3600) / 60)).padStart(2,'0');
      const s = String(diff % 60).padStart(2,'0');
      element.textContent = `${h}:${m}:${s}`;
    }, 1000);
  }

  function startTimerDays(element, start, holder) {
    if (holder.timer) clearInterval(holder.timer);
    holder.timer = setInterval(() => {
      const now = new Date();
      const diff = Math.floor((now - start) / 1000);
      const d = String(Math.floor(diff / 86400)).padStart(2,'0');
      const h = String(Math.floor((diff % 86400) / 3600)).padStart(2,'0');
      const m = String(Math.floor((diff % 3600) / 60)).padStart(2,'0');
      const s = String(diff % 60).padStart(2,'0');
      element.textContent = `${d}:${h}:${m}:${s}`;
    }, 1000);
  }

  function formatDHMS(ms) {
    const total = Math.max(0, Math.floor(ms/1000));
    const d = String(Math.floor(total/86400)).padStart(2,'0');
    const h = String(Math.floor((total%86400)/3600)).padStart(2,'0');
    const m = String(Math.floor((total%3600)/60)).padStart(2,'0');
    const s = String(total%60).padStart(2,'0');
    return `${d}:${h}:${m}:${s}`;
  }

  function stopTimer(element, holder, resetText="00:00:00") {
    if (holder.timer) clearInterval(holder.timer);
    holder.timer = null;
    element.textContent = resetText;
  }

  function getLastDivByLocation(location) {
    return elems[location] ? elems[location].lastDiv : null;
  }
  function renderLastDiv(mainText, subText, lastDiv) {
    if (!lastDiv) return;
    lastDiv.innerHTML = `\n      <div>${mainText}</div>\n      <div style="font-size:20px;color:#e57373;margin-top:10px;">${subText}</div>\n    `;
    lastDiv.style.opacity = '0';
    setTimeout(() => { lastDiv.style.opacity = '1'; }, 100);
  }

  async function handleButtonClick(statusDocRef, logsColRef, location, button, timerEl, onBtnEl, offBtnEl, lastDocRef, isOn) {
    onBtnEl.disabled = true;
    offBtnEl.disabled = true;

    // capture previous ON for specials
    const prevSnap = await statusDocRef.get();
    const prev = prevSnap.exists ? prevSnap.data() : {};
    const prevOnISO = prev && prev.f_on ? prev.f_on : null;

    const nowISO = new Date().toISOString();
    if (isOn) {
      await statusDocRef.set({ currentStatus: "ON", f_on: nowISO, f_off: null });
    } else {
      await statusDocRef.set({ currentStatus: "OFF", f_on: null, f_off: nowISO });
    }
    await logsColRef.add({ action: isOn ? "ON" : "OFF", timestamp: nowISO, location });

    const isSpecial = (location === "Katakhali" || location === "Miapur" || location === "Bindur Mor");

    if (isSpecial) {
      // SPECIAL: update Last Interruption ONLY when OFF is pressed (ON->OFF), and update the DOM immediately
      if (!isOn) {
        const lastDiv = getLastDivByLocation(location);
        let mainText = `Last Interruption: 00:00:00:00`;
        let subText = new Date(nowISO).toLocaleDateString([], { year: 'numeric', month: 'long', day: 'numeric' });
        if (prevOnISO) {
          const diff = new Date(nowISO) - new Date(prevOnISO);
          const timeStr = new Date(nowISO).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true })
                             .replace('am','AM').replace('pm','PM');
          mainText = `Last Interruption: ${formatDHMS(diff)} at ${timeStr}`;
        }
        await lastDocRef.set({ mainText, subText });
        renderLastDiv(mainText, subText, lastDiv);
      }
    } else {
      // others: same as before (update when ON using OFF->ON gap)
      await updateLastInterruption(
        logsColRef, lastDocRef, location, getLastDivByLocation(location)
      );
    }

    updateUI(button, timerEl, isOn ? "ON" : "OFF", nowISO, onBtnEl, offBtnEl, location);
    fetchLogs();
  }



  
  function updateUI(button, timerEl, state, time, onBtnEl, offBtnEl, location) {
    animateButton(button, state);
    const isSpecial = (location === "Katakhali" || location === "Miapur" || location === "Bindur Mor" || location === "Talaimari");
    const holder = timerIntervals[location];

    if (state === "ON") {
      button.style.backgroundColor = "green";
      button.style.color = "white";
      onBtnEl.disabled = true;
      offBtnEl.disabled = false;
      if (isSpecial) startTimerDays(timerEl, new Date(time), holder);
      else stopTimer(timerEl, holder, "00:00:00");
    } else {
      button.style.backgroundColor = "red";
      button.style.color = "white";
      onBtnEl.disabled = false;
      offBtnEl.disabled = true;
      if (isSpecial) {
        // reset (do NOT freeze)
        stopTimer(timerEl, holder, "00:00:00:00");
      } else {
        startTimer(timerEl, new Date(time), holder);
      }
    }
  }

  async function fetchLogs() {
    // fetch all collections in parallel
    const snapshots = await Promise.all(Object.values(logsCols).map(col => col.orderBy('timestamp').get()));

    // map back to named logs
    const allLogs = [];
    snapshots.forEach((snap, idx) => {
      const location = stations[idx].name;
      snap.docs.forEach(d => allLogs.push({ ...d.data(), location }));
    });

    allLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

    if (allLogs.length === 0) {
      console.log("No logs available to display.");
      return; // No logs to display
    }

    logTable.innerHTML = ''; // Clear the table

    let lastOff = {};
    let lastOnSpecial = {};

    allLogs.forEach(data => {
      let interruptionTime = '--';

      if (data.action === "ON") {
        const isSpecial = (data.location === "Katakhali" || data.location === "Miapur" || data.location === "Bindur Mor" || data.location === "Talaimari");
        const lastOffAction = lastOff[data.location];

        if (!isSpecial && lastOffAction) {
          const offTime = new Date(lastOffAction.timestamp);
          const onTime = new Date(data.timestamp);
          const diffMs = onTime - offTime;
          if (diffMs >= 0) {
            const h = String(Math.floor(diffMs / 3600000)).padStart(2, '0');
            const m = String(Math.floor((diffMs % 3600000) / 60000)).padStart(2, '0');
            const s = String(Math.floor((diffMs % 60000) / 1000)).padStart(2, '0');
            interruptionTime = `${h}:${m}:${s}`;
          }
        }
        if (data.location === "Katakhali") lastOnSpecial.Katakhali = data;
        else if (data.location === "Miapur") lastOnSpecial.Miapur = data;
        else if (data.location === "Bindur Mor") lastOnSpecial.BindurMor = data;
        else if (data.location === "Talaimari") lastOnSpecial.Talaimari = data;
      }

      if (data.action === "OFF" && (data.location === "Katakhali" || data.location === "Miapur" || data.location === "Bindur Mor" || data.location === "Talaimari")) {
        const lastOnAction = data.location === "Katakhali" ? lastOnSpecial.Katakhali :
                             data.location === "Miapur" ? lastOnSpecial.Miapur :
                             data.location === "Bindur Mor" ? lastOnSpecial.BindurMor : lastOnSpecial.Talaimari;
        if (lastOnAction) {
          const diffMs = new Date(data.timestamp) - new Date(lastOnAction.timestamp);
          if (diffMs >= 0) interruptionTime = formatDHMS(diffMs);
        }
      }

      if (data.action === "OFF") {
        lastOff[data.location] = data;
      }

      const logDate = new Date(data.timestamp);
      const dateFormatted = logDate.toLocaleDateString('en-GB');
      const timeFormatted = logDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${dateFormatted}</td>
        <td>${data.action}</td>
        <td>${timeFormatted}</td>
        <td>${data.location}</td>
        <td>${interruptionTime}</td>
      `;
      logTable.prepend(row); // Add rows dynamically
    });
  }


  // default updater (non-special)
  async function updateLastInterruption(logsColRef, lastInterruptionDocRef, location, lastDiv) {
    const snapshot = await logsColRef.orderBy('timestamp','desc').limit(2).get();
    const logs = snapshot.docs.map(doc=>doc.data());
    if (logs.length===2 && logs[0].action==="ON" && logs[1].action==="OFF") {
      const onTime = new Date(logs[0].timestamp);
      const offTime = new Date(logs[1].timestamp);
      const diffMs = onTime - offTime;
      const h = String(Math.floor(diffMs/3600000)).padStart(2,'0');
      const m = String(Math.floor((diffMs%3600000)/60000)).padStart(2,'0');
      const s = String(Math.floor((diffMs%60000)/1000)).padStart(2,'0');

      const timeStr = onTime.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:true}).replace('am','AM').replace('pm','PM');
      const dateStr = onTime.toLocaleDateString([], {year:'numeric',month:'long',day:'numeric'});

      const mainText = `Last Interruption: ${h}:${m}:${s} at ${timeStr}`;
      const subText = `${dateStr}`;
      await lastInterruptionDocRef.set({ mainText, subText });
      renderLastDiv(mainText, subText, lastDiv);
    }
  }

  async function fetchCurrentStatus(statusDocRef, button, timerEl, onBtnEl, offBtnEl, location) {
    const doc = await statusDocRef.get();
    if (doc.exists) {
      const data = doc.data();
      if (data.currentStatus === "ON") {
        updateUI(button, timerEl, "ON", data.f_on, onBtnEl, offBtnEl, location);
      } else if (data.currentStatus === "OFF") {
        updateUI(button, timerEl, "OFF", data.f_off, onBtnEl, offBtnEl, location);
        // SPECIAL: when OFF, keep reset (do not freeze)
        if (location==="Katakhali"||location==="Miapur"||location==="Bindur Mor"||location==="Talaimari") {
          const holder = timerIntervals[location];
          stopTimer(timerEl, holder, "00:00:00:00");
        }
      }
    }
  }

  async function fetchLastInterruption(lastInterruptionDocRef, lastDiv) {
    const doc = await lastInterruptionDocRef.get();
    if (doc.exists) {
      const data = doc.data();
      if (data.mainText && data.subText) {
        renderLastDiv(data.mainText, data.subText, lastDiv);
      } else {
        lastDiv.textContent = "Last Interruption: --";
      }
    }
  }

  // Bind buttons dynamically while preserving original behavior
  stations.forEach((s) => {
    const statusDocRef = statusDocs[s.name];
    const logsColRef = logsCols[s.name];
    const lastDocRef = lastDocs[s.name];
    const el = elems[s.name];

    el.onBtn.onclick = () => handleButtonClick(statusDocRef, logsColRef, s.name, el.statusBtn, el.timer, el.onBtn, el.offBtn, lastDocRef, true);
    el.offBtn.onclick = () => handleButtonClick(statusDocRef, logsColRef, s.name, el.statusBtn, el.timer, el.onBtn, el.offBtn, lastDocRef, false);
  });



  let generatedExcelBlob = null;  // Global variable to store the Blob

  // Download Button Logic (keeps logic identical but uses maps)
  downloadBtn.onclick = async () => {
    loadingText.style.display = 'block';

    let lastOff = {};
    let lastOnSpecial = {};

    try {
      // fetch all snapshots in same order as stations array
      const snapshots = await Promise.all(stations.map(s => logsCols[s.name].orderBy('timestamp').get()));

      const allLogs = [];
      snapshots.forEach((snap, idx) => {
        const location = stations[idx].name;
        snap.docs.forEach(doc => allLogs.push({ ...doc.data(), location }));
      });

      allLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      const logsForExcel = allLogs.map(data => {
        const logDate = new Date(data.timestamp);
        const dateFormatted = logDate.toLocaleDateString('en-GB');
        const timeFormatted = logDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });

        let interruptionTime = '--';

        if (data.action === "ON") {
          const lastOffAction = lastOff[data.location];
          if (lastOffAction) {
            const offTime = new Date(lastOffAction.timestamp);
            const onTime = new Date(data.timestamp);
            const diffMs = onTime - offTime;
            if (diffMs >= 0) {
              const h = String(Math.floor(diffMs / 3600000)).padStart(2, '0');
              const m = String(Math.floor((diffMs % 3600000) / 60000)).padStart(2, '0');
              const s = String(Math.floor((diffMs % 60000) / 1000)).padStart(2, '0');
              interruptionTime = `${h}:${m}:${s}`;
            }
          }
        }

        if (data.action === "OFF" && (data.location === "Katakhali" || data.location === "Miapur" || data.location === "Bindur Mor" || data.location === "Talaimari")) {
          const lastOnAction = data.location === "Katakhali" ? lastOnSpecial.Katakhali : data.location === "Miapur" ? lastOnSpecial.Miapur: data.location === "Bindur Mor" ? lastOnSpecial.BindurMor : lastOnSpecial.Talaimari;
          if (lastOnAction) {
            const onTime = new Date(lastOnAction.timestamp);
            const offTime = new Date(data.timestamp);
            const diffMs = offTime - onTime;
            if (diffMs >= 0) {
              interruptionTime = formatDHMS(diffMs);
            }
          }
        }

        if (data.action === "OFF") {
          lastOff[data.location] = data;
        } else if (data.action === "ON") {
          if (data.location === "Katakhali") lastOnSpecial.Katakhali = data;
          else if (data.location === "Miapur") lastOnSpecial.Miapur = data;
          else if (data.location === "Bindur Mor") lastOnSpecial.BindurMor = data;
          else if (data.location === "Talaimari") lastOnSpecial.Talaimari = data;
        }

        return {
          Date: dateFormatted,
          Action: data.action,
          Time: timeFormatted,
          Location: data.location,
          Interruption: interruptionTime
        };
      });

      const worksheet = XLSX.utils.json_to_sheet(logsForExcel);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Logs");

      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      generatedExcelBlob = new Blob([excelBuffer], { type: 'application/octet-stream' });

      const currentDate = new Date();
      const day = String(currentDate.getDate()).padStart(2, '0');
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const year = currentDate.getFullYear();
      let hours = currentDate.getHours();
      const minutes = String(currentDate.getMinutes()).padStart(2, '0');
      const ampm = hours >= 12 ? 'pm' : 'am';
      hours = hours % 12;
      hours = hours ? String(hours).padStart(2, '0') : '12';
      const formattedDateTime = `${day}.${month}.${year}_${hours}.${minutes}${ampm}.xlsx`;

      XLSX.writeFile(workbook, formattedDateTime);

    } catch (error) {
      console.error('Error downloading logs:', error);
      alert('Error downloading logs. See console for details.');
    } finally {
      loadingText.style.display = 'none';
    }
  };

  // Initial loads (preserve same sequence)
  fetchLogs();
  stations.forEach(s => fetchCurrentStatus(statusDocs[s.name], elems[s.name].statusBtn, elems[s.name].timer, elems[s.name].onBtn, elems[s.name].offBtn, s.name));
  stations.forEach(s => fetchLastInterruption(lastDocs[s.name], elems[s.name].lastDiv));

  // New: Reset Button Listener (keeps password and behavior identical)
  document.getElementById('resetButton').addEventListener('click', async () => {
    const password = prompt("Enter the password:");

    if (password === "rst") {
      try {
        const collections = stations.map(s => s.logsCol);

        const deletePromises = collections.map(async (collection) => {
          const logsSnapshot = await db.collection(collection).get();

          if (logsSnapshot.empty) {
            console.log(`${collection} has no logs to delete.`);
            return;
          }

          const batch = db.batch();
          logsSnapshot.docs.forEach((doc) => {
            batch.delete(doc.ref);
          });

          await batch.commit();
          console.log(`${collection} logs deleted.`);
        });

        await Promise.all(deletePromises);

        const logTableBody = document.querySelector('#logTable tbody');
        logTableBody.innerHTML = '';

        alert('All logs from all collections have been deleted.');

        location.reload();
      } catch (error) {
        console.error('Error resetting logs:', error);
        alert('An error occurred while resetting logs.');
      }
    } else {
      alert("Incorrect password. Logs will not be reset.");
    }
  });

</script>



</body>
</html>

